(function(){var p=function(j){(function(){typeof amzn=="undefined"&&(amzn={});if(typeof amzn.c2c=="undefined")amzn.c2c={};amzn.c2c.AudioInputMeter=function(a,e,c,f){if(typeof f=="undefined"||typeof e=="undefined"||typeof c=="undefined"||typeof f=="undefined")throw Error("Invalid parameters to Audio Input Meter");this.canvasId=a;this.audioMeterContext=f;this.canvasContext=this.audioMeter=this.localStream=null;this.AUDIO_METER_WIDTH=e;this.AUDIO_METER_HEIGHT=c;this.localStream=this.mediaStreamSource=
null};amzn.c2c.AudioInputMeter.prototype.turnOnAudioMeter=function(a){this.animationLoop=!0;this.localStream=a;this.mediaStreamSource=this.audioMeterContext.createMediaStreamSource(a);this.audioMeter=this.createAudioMeter(this.audioMeterContext);this.mediaStreamSource.connect(this.audioMeter);this.drawLoop()};amzn.c2c.AudioInputMeter.prototype.turnOffAudioMeter=function(){this.animationLoop=!1;this.audioMeter&&this.audioMeter.shutdown();this.localStream&&this.localStream.stop();if(this.canvasContext)this.canvasContext.clearRect(0,
0,this.AUDIO_METER_WIDTH,this.AUDIO_METER_HEIGHT),this.canvasContext.strokeStyle="black",this.canvasContext.rect(0,0,this.AUDIO_METER_WIDTH,this.AUDIO_METER_HEIGHT),this.canvasContext.stroke()};amzn.c2c.AudioInputMeter.prototype.createAudioMeter=function(a,e,c,f){var g=a.createScriptProcessor(512);g.onaudioprocess=this.volumeAudioProcess;g.clipping=!1;g.lastClip=0;g.volume=0;g.clipLevel=e||0.98;g.averaging=c||0.95;g.clipLag=f||750;g.connect(a.destination);g.checkClipping=function(){if(!this.clipping)return!1;
if(this.lastClip+this.clipLag<window.performance.now())this.clipping=!1;return this.clipping};g.shutdown=function(){this.disconnect();this.onaudioprocess=null};return g};amzn.c2c.AudioInputMeter.prototype.volumeAudioProcess=function(a){for(var a=a.inputBuffer.getChannelData(0),e=a.length,c=0,f,g=0;g<e;g++){f=a[g];if(Math.abs(f)>=this.clipLevel)this.clipping=!0,this.lastClip=window.performance.now();c+=f*f}a=Math.sqrt(c/e);this.volume=Math.max(a,this.volume*this.averaging)};amzn.c2c.AudioInputMeter.prototype.drawLoop=
function(){var a=document.getElementById(this.canvasId);if(a&&this.animationLoop)this.canvasContext=a.getContext("2d"),this.canvasContext.clearRect(0,0,this.AUDIO_METER_WIDTH,this.AUDIO_METER_HEIGHT),this.audioMeter.checkClipping(),this.canvasContext.fillStyle="orange",this.canvasContext.fillRect(0,0,this.audioMeter.volume*this.AUDIO_METER_WIDTH*1.4,this.AUDIO_METER_HEIGHT),this.canvasContext.strokeStyle="black",this.canvasContext.rect(0,0,this.AUDIO_METER_WIDTH,this.AUDIO_METER_HEIGHT),this.canvasContext.stroke(),
setTimeout(this.drawLoop.bind(this),30)}})(j);(function(a){typeof amzn=="undefined"&&(amzn={});if(typeof amzn.c2c=="undefined")amzn.c2c={};amzn.c2c.SipmlAdapter=function(a){this.webCallConfigurationSet=this.contactContextToken=null;this.videoEnabled=a.videoCallClicked;this.SIP_PROTOCOL="sip:";this.AMAZON_SIP_DOMAIN="@amazon.com";this.UDP_PROTOCOL="udp://";this.WSS_URI_REGEXP=/^(?:ws{1,2}:\/\/)?([^:\/]*)(?::(\d+))?(?:\/.*)?$/;this.videoStream=this.audioStream=null;this.widgetStrings=a.strings;this.widgetPointer=
a;this.SIPML_URL="https://images-na.ssl-images-amazon.com/images/G/01/browser-scripts/sipml/sipml-1743198286._CB351660134_.js";this.micOffImage="https://images-na.ssl-images-amazon.com/images/G/01/x-locale/cs/contact-us/images/mute-off.png";this.micOnImage="https://images-na.ssl-images-amazon.com/images/G/01/x-locale/cs/contact-us/images/mute-on.png";this.CANVAS_ID="audio_input_meter";this.CANVAS_WIDTH=200;this.CANVAS_HEIGHT=18;this.audioInputMeter=new amzn.c2c.AudioInputMeter(this.CANVAS_ID,this.CANVAS_WIDTH,
this.CANVAS_HEIGHT,a.audioContext);this.audioOn=!0;this.printStatsIntervalId=this.analyzeStatsIntervalId=null};amzn.c2c.SipmlAdapter.prototype.updateConnectivity=function(e){e>100||(a("#connectivityMeter").show(),e<=5?a("#connectivityStatus").html(this.widgetStrings.connectivityStatusGood):e<20?a("#connectivityStatus").html(this.widgetStrings.connectivityStatusWeak):a("#connectivityStatus").html(this.widgetStrings.connectivityStatusBad))};amzn.c2c.SipmlAdapter.prototype.calculateConnectivity=function(a,
c){a&&c&&c>0&&this.updateConnectivity(a/c*100)};amzn.c2c.SipmlAdapter.prototype.dumpStats=function(a){var c="Timestamp:";c+=a.timestamp;if(a.names){names=a.names();for(var f=0;f<names.length;++f)c+="<br>",c+=names[f],c+=":",c+=a.stat(names[f])}else console.log("No names function"),a.stat("audioOutputLevel")&&(c+="audioOutputLevel: ",c+=a.stat("audioOutputLevel"),c+="<br>");return c};amzn.c2c.SipmlAdapter.prototype.printAllStats=function(e){var c=this;this.printStatsIntervalId=setInterval(function(){e&&
e.getStats&&e.getStats(function(e){for(var g="",e=e.result(),d=0;d<e.length;++d){var b=e[d];console.log(b);g+="<h3>Report ";g+=d;g+="</h3>";b.local&&(g+="<p>Local ",g+=c.dumpStats(b.local));b.remote&&(g+="<p>Remote ",g+=c.dumpStats(b.remote))}a("#allStats").get(0).innerHTML=g})},1E3)};amzn.c2c.SipmlAdapter.prototype.getConnectivity=function(a){a.stat("packetsLost")&&a.stat("packetsSent")&&this.calculateConnectivity(a.stat("packetsLost"),a.stat("packetsSent"))};amzn.c2c.SipmlAdapter.prototype.analyzeStats=
function(a){var c=this;this.analyzeStatsIntervalId=setInterval(function(){a&&a.getStats&&a.getStats(function(a){for(var a=a.result(),e=0;e<a.length;++e){var d=a[e];d.local&&c.getConnectivity(d.local)}})},1E3)};amzn.c2c.SipmlAdapter.prototype.getPeerConnection=function(a){return a&&a.o_stack&&a.o_stack.o_layer_dialog&&a.o_stack.o_layer_dialog.ao_dialogs[0]&&a.o_stack.o_layer_dialog.ao_dialogs[0].o_msession_mgr&&a.o_stack.o_layer_dialog.ao_dialogs[0].o_msession_mgr.ao_sessions[0]&&a.o_stack.o_layer_dialog.ao_dialogs[0].o_msession_mgr.ao_sessions[0].o_pc?
a.o_stack.o_layer_dialog.ao_dialogs[0].o_msession_mgr.ao_sessions[0].o_pc:null};amzn.c2c.SipmlAdapter.prototype.mediaStreamFail=function(){this.videoEnabled?a("#micWebcamError").show():a("#microphoneError").show();this.audioInputMeter.turnOffAudioMeter();this.loadPlaceCallButton()};amzn.c2c.SipmlAdapter.prototype.toggleAudioHandler=function(){if(this.audioOn)a("#toggle_audio").get(0).innerHTML=this.widgetStrings.unmuteButton,this.audioInputMeter.turnOffAudioMeter(),this.audioOn=!1,a("#micOnImage").hide(),
a("#micOffImage").show();else{a("#toggle_audio").get(0).innerHTML=this.widgetStrings.muteButton;a("#micOffImage").hide();a("#micOnImage").show();try{navigator.getUserMedia({audio:!0},this.audioInputMeter.turnOnAudioMeter.bind(this.audioInputMeter),this.mediaStreamFail.bind(this))}catch(e){console.log("getUserMedia threw exception :"+e)}this.audioOn=!0}if(this.audioStream){var c=this.audioStream.getAudioTracks();c&&a.each(c,function(a,c){c.enabled=!c.enabled})}};amzn.c2c.SipmlAdapter.prototype.toggleVideoHandler=
function(){if(this.videoStream){var e=this.videoStream.getVideoTracks();e&&a.each(e,function(a,e){e.enabled=!e.enabled})}};amzn.c2c.SipmlAdapter.prototype.startWebcall=function(){try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia({audio:!0,video:this.videoEnabled},this.webcall.bind(this),this.mediaStreamFail.bind(this))}catch(a){console.log("getUserMedia threw exception :"+a)}};amzn.c2c.SipmlAdapter.prototype.decodeHtml=
function(a){var c=document.createElement("textarea");c.innerHTML=a;return c.value};amzn.c2c.SipmlAdapter.prototype.checkWebcallInfo=function(a){return a&&typeof a.contactContextToken=="string"&&a.contactContextToken.length>0&&typeof a.webCallConfigurationSet!="undefined"&&typeof a.webCallConfigurationSet.configurations!="undefined"&&a.webCallConfigurationSet.configurations.length>0?!0:!1};amzn.c2c.SipmlAdapter.prototype.handleWebcallInfo=function(a){if(a&&typeof a.webCallConfigurationSet==="string")a.webCallConfigurationSet=
this.decodeHtml(a.webCallConfigurationSet),a.webCallConfigurationSet=JSON.parse(a.webCallConfigurationSet);this.checkWebcallInfo(a)?(this.contactContextToken=a.contactContextToken,this.webCallConfigurationSet=a.webCallConfigurationSet,this.startWebcall()):this.widgetPointer._error("Failed to call - non-user error: "+(a?a.error:"no response received"))};amzn.c2c.SipmlAdapter.prototype.getWebcallInfo=function(){var a=this,c=a.widgetPointer.options.initiateC2TCallback(this);if(c&&typeof c.onloadend!=
"undefined"){var f=c.onloadend;c.onloadend=function(){var g=JSON.parse(c.response);typeof f=="function"&&f();a.handleWebcallInfo(g)}}else c&&typeof c.done=="function"?c.done(function(c){a.handleWebcallInfo(c)}):a.handleWebcallInfo(c)};amzn.c2c.SipmlAdapter.prototype.loadInCallButtons=function(){a("#microphoneError").hide();a("#micWebcamError").hide();if(a("#place_call").get(0))a("#place_call").get(0).innerHTML=this.widgetStrings.connectingButton;a("#place_call").unbind("click");a("#toggle_audio").show();
this.videoEnabled&&a("#toggle_video").show();a("#micOnImage").show()};amzn.c2c.SipmlAdapter.prototype.webcall=function(a){this.loadInCallButtons();window.onbeforeunload=function(){return"Warning! Your Amazon call will be disconnected."};this.audioInputMeter.turnOnAudioMeter(a);var a=this.WSS_URI_REGEXP.exec(this.webCallConfigurationSet.configurations[0].signalingEndpoint),c=this.UDP_PROTOCOL+a[1];a[2]&&(c=c+":"+a[2]);this.options={ws_server:this.webCallConfigurationSet.configurations[0].signalingEndpoint,
stun_server:this.webCallConfigurationSet.configurations[0].iceServers[0],from_uri:"sip:click2talkwidget@amazon.com",to_uri:this.SIP_PROTOCOL+"webcall_"+this.widgetPointer.options.serviceGeo+"_"+this.widgetPointer.options.serviceEnv+"@amazon.com",realm:"10.112.0.92",outbound_proxy:c,context:this.contactContextToken,enable_video:this.videoEnabled};this._addMessage("Placing call: "+this.contactContextToken);this.placeCall(this.options);return!1};amzn.c2c.SipmlAdapter.prototype.placeCall=function(e){var c=
this,f,g,d=function(){g&&(g.hangup(),g=null);f&&(f.stop(),f=null);c.audioStream=null;c.videoStream=null;c.loadPlaceCallButton();c.printStatsIntervalId!==null&&clearInterval(c.printStatsIntervalId);c.analyzeStatsIntervalId!==null&&clearInterval(c.analyzeStatsIntervalId);c.audioInputMeter.turnOffAudioMeter();c.widgetPointer.changeWebcallStatus(amzn.c2c.callStatusCodes.DISCONNECTED);window.onbeforeunload=null;window.onunload=null};window.onunload=d;var b=function(){g=f.newSession(e.enable_video?"call-audiovideo":
"call-audio",{audio_remote:a("#remote_audio")[0],video_remote:a("#remote_video")[0],video_local:a("#local_video")[0],sip_caps:[{name:"+sip.ice"}],sip_headers:[{name:"X-AmznContext",value:e.context}]});g.addEventListener("*",function(b){switch(b.type){case "connecting":c._addMessage("Connecting session.");break;case "connected":c.gotConnected=!0;a("#place_call").get(0).innerHTML=c.widgetStrings.connectedButton;c.widgetPointer.changeWebcallStatus(amzn.c2c.callStatusCodes.CONNECTED);c._addMessage("Session connected.");
break;case "terminating":if(a("#place_call").get(0))a("#place_call").get(0).innerHTML=c.widgetStrings.hangingUpButton;c._addMessage("Terminating session.");break;case "terminated":c._addMessage("Session terminated.");c.gotConnected?d():(c.audioInputMeter.turnOffAudioMeter(),c.startWebcall());break;case "m_stream_audio_local_added":c.audioStream=b.session.o_session.get_stream_local();break;case "m_stream_audio_local_removed":c.audioStream=null;break;case "m_stream_video_local_added":c.videoStream=
b.session.o_session.get_stream_local();break;case "m_stream_video_local_removed":c.videoStream=null;break;case "m_stream_audio_remote_added":b=c.getPeerConnection(f),b!==null&&c.analyzeStats(b)}});g.call(e.to_uri)};c.widgetPointer._find("a.c2c-hangup-button, a.c2c-back-button").unbind("click").click(function(a){d();a.preventDefault()});f=new SIPml.Stack({realm:e.realm,impi:"Click2TalkWidget",impu:e.from_uri,ice_servers:[{url:e.stun_server}],password:"",websocket_proxy_url:e.ws_server,outbound_proxy_url:e.outbound_proxy,
enable_rtcweb_breaker:!1,enable_click2call:!1,events_listener:{events:["started","stopped"],listener:function(a){c._addMessage("Stack "+a.type);switch(a.type){case "started":b()}}}});f.start()};amzn.c2c.SipmlAdapter.prototype._addMessage=function(a,c){var f="";c!==void 0&&c.data!==void 0&&(f=": "+JSON.stringify(c.data));console.log("[SIPML STATUS] "+(new Date).toTimeString()+" "+a+" "+f)};amzn.c2c.SipmlAdapter.prototype.loadPlaceCallButton=function(){if(a("#place_call").get(0))a("#place_call").get(0).innerHTML=
this.widgetStrings.placeCallButton;a("#place_call").one("click",this.getWebcallInfo.bind(this));a("#toggle_audio").hide();a("#toggle_video").hide();a("#connectivityMeter").hide()};amzn.c2c.SipmlAdapter.prototype.loadSipml=function(){var a=document.createElement("script");a.type="text/javascript";document.body.appendChild(a);a.onload=this.loadPlaceCallButton.bind(this);a.src=this.SIPML_URL};amzn.c2c.SipmlAdapter.prototype.bindButtons=function(){var e=this;a("#toggle_audio").click(e.toggleAudioHandler.bind(this));
e.videoEnabled&&(a("#toggle_video").click(e.toggleVideoHandler.bind(this)),a("#remote_video").show(),a("#local_video").show());e.widgetPointer._find("a.c2c-back-button").unbind("click").click(function(a){e.widgetPointer._setState(e.widgetPointer.states.initial);a.preventDefault()})};amzn.c2c.SipmlAdapter.prototype.initSipmlWebcall=function(){this.loadSipml();var a='<div id="microphoneError" style="display:none">'+this.widgetStrings.micErrorMessage+'</div><div id="micWebcamError" style="display:none">'+
this.widgetStrings.micWebcamErrorMessage+'</div><span id="place_call">'+this.widgetStrings.loadingButton+'</span><span id="toggle_audio" style="display:none">'+this.widgetStrings.muteButton+'</span><span id="toggle_video" style="display:none">'+this.widgetStrings.toggleVideoButton+'</span><div id="media"><span id="micImage" style="min-width:15px;display:inline-block"><img id="micOnImage" src='+this.micOnImage+' style="display:none;margin-top:2px"><img id="micOffImage" src='+this.micOffImage+' style="display:none;margin-top:2px"></span><canvas id="'+
this.CANVAS_ID+'" width="'+this.CANVAS_WIDTH+'" height="'+this.CANVAS_HEIGHT+'" style="margin-left:2px;margin-top:2px"></canvas><div id="connectivityMeter" style="display:none;margin-top:2px"><b>'+this.widgetStrings.connectivityMeter+' <span id="connectivityStatus">'+this.widgetStrings.connectivityStatusUnknown+'</span></b></div><audio id="remote_audio" autoplay volume=\'1.0\'></audio><video id="local_video" style="display:none" width="320" height="240" autoplay mute></video><video id="remote_video" style="display:none" autoplay volume=\'1.0\'></video></div><div id="allStats"></div>';
this.widgetPointer._find("div.webcall-container").html(a);this.bindButtons()}})(j)};window.P&&window.P.AUI_BUILD_DATE?P.when("jQuery","TelephonyC2CCommon").execute(function(j){p(j);P.register("TelephonyClick2Call",function(){})}):p(window.jQuery)})();